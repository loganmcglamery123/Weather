<div class="card">
    <h2>Custom Hourly NAM Forecast (Raw Data)</h2>
    <div class="table-container">
        <table id="forecast-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Temp</th>
                    <th>Wind</th>
                    <th>Gust</th>
                    <th>Dir</th>
                </tr>
            </thead>
            <tbody id="forecast-body">
                <tr><td colspan="5">Fetching Raw NAM 3km data...</td></tr>
            </tbody>
        </table>
    </div>
    <p style="font-size: 0.7rem; color: #666; margin-top: 5px;">Source: NWS Grid Data (NAM-3km)</p>
</div>

<script>
    async function getRawNAMData() {
        try {
            // 1. Get the Raw Grid Data for Peterson Butte
            // This endpoint contains the high-res model arrays (NAM/HRRR)
            const gridUrl = "https://api.weather.gov/gridpoints/PQR/101,84"; 
            const res = await fetch(gridUrl);
            const data = await res.json();
            const props = data.properties;

            // Helper to find the value for the current hour in NWS weird time formats
            const getValueAtTime = (prop) => {
                const now = new Date().toISOString();
                const entry = prop.values.find(v => now >= v.validTime.split('/')[0]);
                return entry ? Math.round(entry.value * 2.23694) : "--"; // Convert m/s to mph
            };

            // 2. Build the table for the next 8 hours
            let html = "";
            const now = new Date();

            for (let i = 0; i < 8; i++) {
                const forecastTime = new Date(now.getTime() + (i * 60 * 60 * 1000));
                const timeStr = forecastTime.toLocaleTimeString([], { hour: 'numeric', hour12: true });

                // NWS Grid units are metric; we convert to mph/F
                const tempC = props.temperature.values[i].value;
                const tempF = Math.round((tempC * 9/5) + 32);
                
                const speedMps = props.windSpeed.values[i].value;
                const speedMph = Math.round(speedMps * 2.23694);
                
                // Extracting Gust - RAW grid almost always has this value
                const gustMps = props.windGust.values[i] ? props.windGust.values[i].value : speedMps;
                const gustMph = Math.round(gustMps * 2.23694);
                
                const deg = props.windDirection.values[i].value;
                
                html += `<tr>
                    <td>${timeStr}</td>
                    <td>${tempF}°</td>
                    <td>${speedMph}</td>
                    <td class="gust">${gustMph}</td>
                    <td><span class="dir" style="transform: rotate(${deg}deg)">↓</span></td>
                </tr>`;
            }
            document.getElementById('forecast-body').innerHTML = html;
        } catch (err) {
            document.getElementById('forecast-body').innerHTML = "<tr><td colspan='5'>Error: Model data unavailable.</td></tr>";
        }
    }
    getRawNAMData();
</script>
